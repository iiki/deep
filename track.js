var asyncLoad=function(e,t){if(!document.getElementById(t)){var n=document.createElement("script");n.type="text/javascript";n.id=t;n.async=true;n.src=e;var r=document.getElementsByTagName("script")[0];r.parentNode.insertBefore(n,r)}};var timeFormat=function(e){var t=parseInt(e);var n=Math.floor(t/60);var r=Math.floor(t%60);if(n<10)n="0"+n;if(r<10)r="0"+r;return n+":"+r};var getAudio=function(e){for(var t=0;t<e.attachments.length;++t){if(e.attachments[t].type!="audio")continue;return e.attachments[t].audio}return undefined};var getPhoto=function(e){for(var t=0;t<e.attachments.length;++t){if(e.attachments[t].type!="photo")continue;return e.attachments[t].photo}return undefined};var getRating=function(e){if(e==undefined)return-1;var t=0;if(e.comments)t+=e.comments.count*3;if(e.reposts)t+=e.reposts.count*2;if(e.likes)t+=e.likes.count;return t};var createTrack=function(e){if(e==undefined||e.attachments==undefined)return undefined;var t=getAudio(e),n=getPhoto(e);if(t==undefined||n==undefined)return undefined;return{id:e.date+e.id,title:t.performer+" - "+t.title,duration:timeFormat(t.duration),audio:t.url,photo:n.src,rating:getRating(e),url:"https://vk.com/wall"+e.to_id+"_"+e.id}};var addTrack=function(e){var t=document.createElement("li"),n=document.createElement("div"),r=document.createElement("div"),i=document.createElement("div"),s=document.createElement("span"),o=document.createElement("div"),u=document.createElement("div"),a=document.createElement("div"),f="track"+e.id;n.className="track";r.className="track-image";i.className="track-holder";s.className="rating";o.className="track-title";u.className="track-duration";a.className="track-ctrls";r.style.backgroundImage="url("+e.photo+")";o.innerHTML=e.title;u.innerText=e.duration;s.innerText=e.rating;a.innerHTML='<a class="track-btn" target="_blank" href="'+e.url+'" onclick="event.stopPropagation();">Go to track page</a>';i.appendChild(o);i.appendChild(u);i.appendChild(a);r.appendChild(s);n.appendChild(r);n.appendChild(i);t.appendChild(n);t.id=f;t.setAttribute("onclick",'return play("'+f+'", "'+e.title+'", "'+e.audio+'");');document.getElementById("tracks").appendChild(t);window._pl.push({id:f,audio:e.audio,title:e.title})};var clearAll=function(){var e=document.getElementsByClassName("li-active");for(var t=0;t<e.length;++t)e[t].classList.remove("li-active")};var play=function(e,t,n){if(window._p==undefined||window._pl==undefined)return false;clearAll();setHeader("Playing "+t);window._p.play(n);window._id=e;document.getElementById(e).classList.add("li-active");if(ga!=undefined){ga("send","event","player","play")}return true};var playNext=function(){if(window._pl==undefined||window._id==undefined)return false;if(ga!=undefined){ga("send","event","player","play_next")}if(window._pl[window._pl.length-1].id===window._id)return play(window._pl[0].id,window._pl[0].title,window._pl[0].audio);else{for(var e=0;e<window._pl.length;++e){if(window._pl[e].id===window._id){return play(window._pl[e+1].id,window._pl[e+1].title,window._pl[e+1].audio)}}}};var setHeader=function(e){document.title=e;document.getElementById("header").innerHTML=e};var getTracks=function(){var e=[34220506,55526638,31134999,23125104,14114],t,n=[],r=[];for(var i=0;i<e.length;++i){t=function(e){var t=new $.Deferred;VK.Api.call("wall.get",{owner_id:-e,count:50},function(e){for(var n=1;n<e.response.length;++n){var i=e.response[n];if(i.is_pinned||i.attachments==undefined||i.attachments.length!=2)continue;var s=createTrack(i);if(s==undefined)continue;r.push(s)}return t.resolve()});return t.promise()}(e[i]);n.push(t)}$.when.apply($,n).done(function(){var e=0,t=0,n=[];for(;t<r.length;++t){e+=r[t].rating}e=parseInt(e/r.length);setHeader("Track list. AVG rating "+e);for(t=0;t<r.length;++t){if(r[t].rating>e)n.push(r[t]);else{delete r[t];r.splice(t,1)}}$(n).sort(function(e,t){return e.rating>t.rating?-1:1}).each(function(e,t){addTrack(t)})})};window.onload=function(){var e=document.getElementById("slider");window._pl=[];window._p=new Player({id:"player",ontime:function(t){e.style.width=t+"%"},onended:function(){playNext()}});window.vkAsyncInit=function(){VK.init({apiId:4488055});VK.Auth.getLoginStatus(function(){getTracks()})};asyncLoad("http://vk.com/js/api/openapi.js","vk-openapi")}